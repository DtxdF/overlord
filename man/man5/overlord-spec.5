.\"Copyright (c) 2025, Jesús Daniel Colmenares Oviedo <DtxdF@disroot.org>
.\"All rights reserved.
.\"
.\"Redistribution and use in source and binary forms, with or without
.\"modification, are permitted provided that the following conditions are met:
.\"
.\"* Redistributions of source code must retain the above copyright notice, this
.\"  list of conditions and the following disclaimer.
.\"
.\"* Redistributions in binary form must reproduce the above copyright notice,
.\"  this list of conditions and the following disclaimer in the documentation
.\"  and/or other materials provided with the distribution.
.\"
.\"* Neither the name of the copyright holder nor the names of its
.\"  contributors may be used to endorse or promote products derived from
.\"  this software without specific prior written permission.
.\"
.\"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
.\"AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\"IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
.\"DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
.\"FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\"DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
.\"SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
.\"CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
.\"OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
.\"OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.Dd January 13, 2025
.Dt OVERLORD-SPEC 5
.Os
.Sh NAME
.Nm overlord-spec
.Nd Overlord specification for configuration files
.Sh CONFIGURATION
.Bl -tag -compact -width xxx
.It Sy serverid
Path to a file containing the server identifier. Give all responsability to Overlord
for generating this identifier, or in other words, do not manually change the
contents of the file.
.Pp
.It Sy port
Specify the source port Overlord's API server should use.
.Pp
.It Sy debug
Shorthand for several debug mode settings. 
.Pp
See also
.Lk https://www.tornadoweb.org/en/stable/web.html#tornado.web.Application.settings "Application configuration"
.Pp
.It Sy compress_response
If True, responses in textual formats will be compressed automatically.
.Pp
See also
.Lk https://www.tornadoweb.org/en/stable/web.html#tornado.web.Application.settings "Application configuration"
.Pp
.It Sy polling
Polling configuration.
.Pp
.It Sy polling.jail_stats
How long to sleep after re-collecting
.Xr rctl 4
statistics.
.Pp
.It Sy polling.jail_info
How much time to sleep after collecting information from the jails again.
.Pp
.It Sy polling.projects
How long to sleep afterwards to get the project list back.
.Pp
.It Sy polling.jails
How long to sleep afterwards to get the jail list back.
.Pp
.It Sy polling.jail_extras
How much time to sleep after collecting additional information from the jails again.
.Pp
.It Sy polling.project_info
How much time to sleep after collecting information from the projects again.
.Pp
.It Sy polling.skew
After repeating the polling operation, a random number will be added to the previous
numbers. The random number will be generated using the range specified in this parameter.
.Pp
.It Sy polling.keywords
Keywords to use to get information.
.Pp
.It Sy polling.keywords.stats
See the
.Sx KEYWORDS
section in
.Xr appjail-limits 1
for details.
.Pp
.It Sy polling.keywords.jail
See the
.Sx KEYWORDS
section in
.Xr appjail-jail 1
for details.
.Pp
.It Sy polling.keywords.devfs
See the
.Sx KEYWORDS
section in
.Xr appjail-devfs 1
for details.
.Pp
.It Sy polling.keywords.expose
See the
.Sx KEYWORDS
section in
.Xr appjail-expose 1
for details.
.Pp
.It Sy polling.keywords.healthcheck
See the
.Sx KEYWORDS
section in
.Xr appjail-healthcheck 1
for details.
.Pp
.It Sy polling.keywords.label
See the
.Sx KEYWORDS
section in
.Xr appjail-label 1
for details.
.Pp
.It Sy polling.keywords.limits
See the
.Sx KEYWORDS
section in
.Xr appjail-limits 1
for details.
.Pp
.It Sy polling.keywords.nat
See the
.Sx KEYWORDS
section in
.Xr appjail-nat 1
for details.
.Pp
.It Sy polling.keywords.volume
See the
.Sx KEYWORDS
section in
.Xr appjail-volume 1
for details.
.Pp
.It Sy polling.keywords.fstab
See the
.Sx KEYWORDS
section in
.Xr appjail-fstab 1
for details.
.Pp
.It Sy memcache
Configuration for the memcache client.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.connections
An array of addresses pointing to memcache servers.
.Pp
.It Sy memcache.max_pool_size
maximum pool size to use.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.PooledClient "pymemcache.client.base.PooledClient"
.Pp
.It Sy memcache.pool_idle_timeout
pooled connections are discarded if they have been unused for this many seconds.
A value of 0 indicates that pooled connections are never discarded.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.PooledClient "pymemcache.client.base.PooledClient"
.Pp
.It Sy memcache.retry_attempts
Amount of times a client should be tried before it is marked dead and removed from the pool.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.retry_timeout
Time in seconds that should pass between retry attempts.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.dead_timeout
Time in seconds before attempting to add a node back in the pool.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.connect_timeout
Seconds to wait for a connection to the memcached server.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy memcache.timeout
Seconds to wait for send or recv calls on the socket connected to memcached.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy memcache.no_delay
Set the
.Sy TCP_NODELAY
flag, which may help with performance in some cases.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy secret_key
Secret key for signing the JWT.
.Pp
.It Sy log_config
Logging configuration.
.Pp
See also
.Lk https://docs.python.org/3/library/logging.config.html#logging.config.dictConfig "logging.conf.dictConfig"
.Pp
.It Sy chains
Chain configuration.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .entrypoint
URL to connect to.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .access_token
Access token.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .timeout
Timeout for all operations.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .read_timeout
Specified the maximum duration to wait for a chunk of data to be received
.Po for example, a chunk of the response body). If HTTPX is unable to receive data within this time frame Pc Ns ,
a
.Sy httpx.ReadTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .write_timeout
Specifies the maximum duration to wait for a chunk of data to be sent
.Po for example, a chunk of the request body Pc Ns "."
If HTTPX is unable to send data within this time frame, a
.Sy httpx.WriteTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .connect_timeout
Specifies the maximum amount of time to wait until a socket connection to the requested host is established. If HTTPX is unable to connect within this time frame, a
.Sy httpx.ConnectTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .pool_timeout
Specifies the maximum duration to wait for acquiring a connection from the connection pool. If HTTPX is unable to acquire a connection within this time frame, a PoolTimeout exception is raised. A related configuration here is the maximum number of allowable connections in the connection pool, which is configured by the limits argument.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .max_keepalive_connections
Number of allowable keep-alive connections.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .max_connections
Maximum number of allowable connections.
.Pp
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .keepalive_expiry
Time limit on idle keep-alive connections in seconds.
.Pp
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy labels
List of labels for the API server.
.Pp
.It Sy director
Director configuration.
.Pp
.It Sy director.logs
Path to the logs directory created by Director.
.Pp
.It Sy appjail
AppJail configuration.
.Pp
.It Sy appjail.logs
Path to the logs directory created by AppJail.
.Pp
.It Sy beanstalkd_addr
Beanstalkd address to connect to. Use the
.Sy unix:
prefix to connect to a UNIX socket. If the port is not specified,
.Sy 11300
will be used.
.Pp
.It Sy execution_time
Maximum time to execute a command or
.Sy null
to not set a timeout.
.Pp
.It Sy dataplaneapi
Data Plane API settings to configure HAProxy.
.Pp
.It Sy dataplaneapi.auth
Data Plane API authentication parameters.
.Pp
.It Sy dataplaneapi.auth.username
Data Plane API username.
.Pp
.It Sy dataplaneapi.auth.password
Data Plane API password.
.Pp
.It Sy dataplaneapi.entrypoint
.It Sy dataplaneapi.timeout
.It Sy dataplaneapi.read_timeout
.It Sy dataplaneapi.write_timeout
.It Sy dataplaneapi.connect_timeout
.It Sy dataplaneapi.pool_timeout
.It Sy dataplaneapi.max_keepalive_connections
.It Sy dataplaneapi.max_connections
.It Sy dataplaneapi.keepalive_expiry
See
.Sy chains. Ns Ar chain Ns Sy .*
for details.
.Pp
.It Sy skydns
.No Configuration to manipulate the SkyDNS Ns / Ns Xr coredns-etcd 7 No plugin.
.Pp
.It Sy skydns.path
The path inside etcd.
.Pp
.It Sy skydns.zone
Authoritative zone.
.Pp
.It Sy etcd
Configuration to connect to etcd instances.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .port
Port to connect to the etcd instance.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .protocol
Protocol
.Po or scheme Pc Ns "."
.Pp
.It Sy etcd. Ns Ar host Ns Sy .ca_cert
Local cert to use as client side certificate.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .cert_key
Private key.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .timeout
Number of seconds to wait for the client to establish a connection to the etcd
instance and to wait for the server to send a response.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .api_path
The part that specifies the API version of etcd. Do not specify any if you want
to leave the responsability of discovering the API version to the library.
.Pp
.It Sy max_watch_projects
Maximum number of jobs to wait in parallel to create or destroy projects, which
must be greater than or equal to 1. By default, the number of available CPUs is
used.
.El
.Sh DEPLOYMENT
.Bl -tag -compact -width xxx
.It Sy kind
What kind of deployment is this file.
.Pp
Valid choices are
.Sy directorProject
and
.Sy metadata Ns "."
.Pp
.It Sy datacenters
Servers to perform HTTP requests.
.Pp
.It Sy datacenters. Ns Ar datacenter Ns Sy .entrypoint
.It Sy datacenters. Ns Ar datacenter Ns Sy .access_token
.It Sy datacenters. Ns Ar datacenter Ns Sy .timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .read_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .write_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .connect_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .pool_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .max_keepalive_connections
.It Sy datacenters. Ns Ar datacenter Ns Sy .max_connections
.It Sy datacenters. Ns Ar datacenter Ns Sy .keepalive_expiry
See
.Sy chains. Ns Ar chain Ns Sy .*
in
.Sx CONFIGURATION
for details.
.Pp
.It Sy deployIn
Specify where to deploy.
.Pp
.It Sy deployIn.entrypoints
List of entry points to connect to that may have the chain with a syntax such as
.Sy  Ns Ar datacenter Ns Sy .{chainA}.{chainB}.
.Pp
By default, when no entry point is specified, data centers will be used as the
entry points.
.Pp
.It Sy deployIn.labels
Deploy to servers with these labels. When no labels are specified, the
.Sy all
label is used.
.Pp
.It Sy deployIn.exclude
Exclude servers matching the specified labels.
.Pp
.It Sy projectName
Project name.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy projectFile
Content of the project.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy projectFromMetadata
Like
.Sy projectFile
but it obtains the content of the project from a metadata.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy environment
A dictionary with each key-value environment. Both the key and the value must be a string.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy environFromMetadata
Like
.Sy environment
but obtains a dictionary from a metadata in YAML format.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy datacentersEnvironment
Each key must be a datacenter and its value a dictionary such as
.Sy environment
specifying the environment to use depending on the datacenter.
.Pp
This parameter overrides any other environment-like option.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy chainsEnvironment
Each key must be a chain and its value a dictionary such as
.Sy environment
specifying the environment to use depending on the chain.
.Pp
This parameter overrides any other environment-like option except
.Sy datacentersEnvironment Ns "."
.Pp
A special key
.Sy <root>
can be used when a request is to be made to a datacenter but without speciying a chain.
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy labelsEnvironment
Each key must be a label and its value a dictionary such as
.Sy environment
specifying the environment to use depending on whether the datacenter and its chain
have a label that matches a key.
.Pp
This parameter overrides any other environment-like option except
.Sy datacentersEnvironment
and
.Sy chainsEnvironment Ns "."
.Pp
Valid only for
.Sy deployProject Ns "."
.Pp
.It Sy maximumDeployments
The maximum number of times to deploy a project.
.Pp
.It Sy metadata
A dictionary speciying the metadata to be stored.
.Pp
Valid only for
.Sy metadata Ns "."
.Pp
.It Sy autoScale
When at least one option of this parameter is set, a metadata named
.Sy overlord.autoscale. Ns Ar project
is created instead of simply deploying the project to the matching nodes. It is
assumed that the remote Overlord instance will read the metadata to deploy and
autoscale the project depending on how many chains it has.
.Pp
The counterpart to destroying a project is to create another metadata named
.Sy overlord.autoscale-cleanup. Ns Ar project Ns "."
This is an indication to the Overlord instance not to deploy any more projects
and to destroy the ones that are currently deployed.
.Pp
If the
.Sy overlord.autoscale. Ns Ar project
metadata have at least one change, the project is redeployed to the nodes that
have the project.
.Pp
.It Sy autoScale.replicas
Configuration parameters used to replicate the project.
.Pp
.It Sy autoScale.replicas.min
The minimum number of replicas this project will have. It depends on the number
of matching and working chains.
.Pp
.It Sy autoScale.replicas.max
When scaling the project due to
.Xr rctl 8
rules, this limits the number of deployments. By default, the number of matched
and working chains calculated at runtime is used.
.Pp
.It Sy autoScale.type
When at least one
.Xr rctl 8
rule is specified to scale the project based on the jail metrics, this indicates
how the metric should be evaluated.
.Pp
.Bl -tag -width xxxxx
.It Sy any-jail
Fails if any of the jails have a metric greater than or equal to the specified
limit.
.It Sy any-project
Fails if the metric total for all jails in the same project is greater than or
equal to the specified limit.
.It Sy average
Calculates the average of the metric for all jails in the same project and fails
if it is greater than or equal to the specified limit.
.It Sy percent-jail
Calculates the percentage of the specified limit and fails if it is greater than or equal to the current metric. For example, if you define a rule as
.Dq vmemoryuse=512m
and a percentage of
.Sy 60 Ns ,
the value will be
.Sy 307
.Po rounded Pc Ns ,
so this test fails if the current metric is greater than or equal to
.Sy 307 Ns "."
.It Sy percent-project
Like
.Sy percent-jail Ns ,
but first get the metric total for all jails in the same project
.El
.Pp
.It Sy autoScale.value
If the type requires a value such as
.Sy percent-jail
or
.Sy percent-project Ns ,
this parameter must be used.
.Pp
.It Sy autoScale.rules
A dictionary specifying the
.Xr rctl 8
rules. Each key-value must specify the rule and the limit, and if that limit is
reached, more instances of the project will be created.
.Pp
.It Sy autoScale.labels
See
.Sy deployIn.labels
for details.
.Pp
.El
.Sh SEE ALSO
.Xr overlord 1
.Sh AUTHORS
.An Jesús Daniel Colmenares Oviedo Aq Mt DtxdF@disroot.org

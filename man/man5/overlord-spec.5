.\"Copyright (c) 2025, Jesús Daniel Colmenares Oviedo <DtxdF@disroot.org>
.\"All rights reserved.
.\"
.\"Redistribution and use in source and binary forms, with or without
.\"modification, are permitted provided that the following conditions are met:
.\"
.\"* Redistributions of source code must retain the above copyright notice, this
.\"  list of conditions and the following disclaimer.
.\"
.\"* Redistributions in binary form must reproduce the above copyright notice,
.\"  this list of conditions and the following disclaimer in the documentation
.\"  and/or other materials provided with the distribution.
.\"
.\"* Neither the name of the copyright holder nor the names of its
.\"  contributors may be used to endorse or promote products derived from
.\"  this software without specific prior written permission.
.\"
.\"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
.\"AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\"IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
.\"DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
.\"FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\"DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
.\"SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
.\"CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
.\"OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
.\"OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.Dd January 13, 2025
.Dt OVERLORD-SPEC 5
.Os
.Sh NAME
.Nm overlord-spec
.Nd Overlord specification for configuration files
.Sh CONFIGURATION
.Bl -tag -compact -width xxx
.It Sy serverid
Path to a file containing the server identifier. Give all responsability to Overlord
for generating this identifier, or in other words, do not manually change the
contents of the file.
.Pp
.It Sy port
Specify the source port Overlord's API server should use.
.Pp
.It Sy tls
Configure the API server to listen on an alternate port for encrypted connections.
.Pp
.It Sy tls.keyfile
Private key filename.
.Pp
.It Sy tls.certfile
Certificate filename.
.Pp
.It Sy tls.port
Alternate port for listening to encrypted connections.
.Pp
.It Sy debug
Shorthand for several debug mode settings. 
.Pp
See also
.Lk https://www.tornadoweb.org/en/stable/web.html#tornado.web.Application.settings "Application configuration"
.Pp
.It Sy compress_response
If True, responses in textual formats will be compressed automatically.
.Pp
See also
.Lk https://www.tornadoweb.org/en/stable/web.html#tornado.web.Application.settings "Application configuration"
.Pp
.It Sy polling
Polling configuration.
.Pp
.It Sy polling.jail_stats
How long to sleep after re-collecting
.Xr rctl 4
statistics.
.Pp
.It Sy polling.jail_info
How much time to sleep after collecting information from the jails again.
.Pp
.It Sy polling.projects
How long to sleep afterwards to get the project list back.
.Pp
.It Sy polling.jails
How long to sleep afterwards to get the jail list back.
.Pp
.It Sy polling.jail_extras
How much time to sleep after collecting additional information from the jails again.
.Pp
.It Sy polling.project_info
How much time to sleep after collecting information from the projects again.
.Pp
.It Sy polling.skew
After repeating the polling operation, a random number will be added to the previous
numbers. The random number will be generated using the range specified in this parameter.
.Pp
.It Sy polling.keywords
Keywords to use to get information.
.Pp
.It Sy polling.keywords.stats
See the
.Sx KEYWORDS
section in
.Xr appjail-limits 1
for details.
.Pp
.It Sy polling.keywords.jail
See the
.Sx KEYWORDS
section in
.Xr appjail-jail 1
for details.
.Pp
.It Sy polling.keywords.devfs
See the
.Sx KEYWORDS
section in
.Xr appjail-devfs 1
for details.
.Pp
.It Sy polling.keywords.expose
See the
.Sx KEYWORDS
section in
.Xr appjail-expose 1
for details.
.Pp
.It Sy polling.keywords.healthcheck
See the
.Sx KEYWORDS
section in
.Xr appjail-healthcheck 1
for details.
.Pp
.It Sy polling.keywords.label
See the
.Sx KEYWORDS
section in
.Xr appjail-label 1
for details.
.Pp
.It Sy polling.keywords.limits
See the
.Sx KEYWORDS
section in
.Xr appjail-limits 1
for details.
.Pp
.It Sy polling.keywords.nat
See the
.Sx KEYWORDS
section in
.Xr appjail-nat 1
for details.
.Pp
.It Sy polling.keywords.volume
See the
.Sx KEYWORDS
section in
.Xr appjail-volume 1
for details.
.Pp
.It Sy polling.keywords.fstab
See the
.Sx KEYWORDS
section in
.Xr appjail-fstab 1
for details.
.Pp
.It Sy memcache
Configuration for the memcache client.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.connections
An array of addresses pointing to memcache servers.
.Pp
.It Sy memcache.max_pool_size
maximum pool size to use.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.PooledClient "pymemcache.client.base.PooledClient"
.Pp
.It Sy memcache.pool_idle_timeout
pooled connections are discarded if they have been unused for this many seconds.
A value of 0 indicates that pooled connections are never discarded.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.PooledClient "pymemcache.client.base.PooledClient"
.Pp
.It Sy memcache.retry_attempts
Amount of times a client should be tried before it is marked dead and removed from the pool.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.retry_timeout
Time in seconds that should pass between retry attempts.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.dead_timeout
Time in seconds before attempting to add a node back in the pool.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.hash.html#pymemcache.client.hash.HashClient "pymemcache.client.hash module"
.Pp
.It Sy memcache.connect_timeout
Seconds to wait for a connection to the memcached server.
.Pp
Use 0 to use the default timeout, or -1 to disable it.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy memcache.timeout
Seconds to wait for send or recv calls on the socket connected to memcached.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy memcache.no_delay
Set the
.Sy TCP_NODELAY
flag, which may help with performance in some cases.
.Pp
See also
.Lk https://pymemcache.readthedocs.io/en/latest/apidoc/pymemcache.client.base.html#pymemcache.client.base.Client "pymemcache.client.base.Client"
.Pp
.It Sy secret_key
Secret key for signing the JWT.
.Pp
If this parameter is set,
.Sy secret_keyfile
will have no effect.
.Pp
.It Sy secret_keyfile
Like
.Sy secret_key Ns ,
but with some differences. First, this parameter points to a path where the
secret key is stored, and second, the secret key is randomly generated.
By default, since the
.Sy secret_key
parameter is not set, a random secret key is generated which is more secure than
using a default
.Pq and insecure
secret key.
.Pp
.It Sy log_config
Logging configuration.
.Pp
See also
.Lk https://docs.python.org/3/library/logging.config.html#logging.config.dictConfig "logging.conf.dictConfig"
.Pp
.It Sy chains
Chain configuration.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .entrypoint
URL to connect to.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .access_token
Access token.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .disable
Disable this chain. Useful for when the chain is temporarily unresponsive.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .timeout
Timeout for all operations.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .read_timeout
Specified the maximum duration to wait for a chunk of data to be received
.Po for example, a chunk of the response body). If HTTPX is unable to receive data within this time frame Pc Ns ,
a
.Sy httpx.ReadTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .write_timeout
Specifies the maximum duration to wait for a chunk of data to be sent
.Po for example, a chunk of the request body Pc Ns "."
If HTTPX is unable to send data within this time frame, a
.Sy httpx.WriteTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .connect_timeout
Specifies the maximum amount of time to wait until a socket connection to the requested host is established. If HTTPX is unable to connect within this time frame, a
.Sy httpx.ConnectTimeout
exception is raised.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .pool_timeout
Specifies the maximum duration to wait for acquiring a connection from the connection pool. If HTTPX is unable to acquire a connection within this time frame, a PoolTimeout exception is raised. A related configuration here is the maximum number of allowable connections in the connection pool, which is configured by the limits argument.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/timeouts "Timeouts"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .max_keepalive_connections
Number of allowable keep-alive connections.
.Pp
See also
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .max_connections
Maximum number of allowable connections.
.Pp
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .keepalive_expiry
Time limit on idle keep-alive connections in seconds.
.Pp
.Lk https://www.python-httpx.org/advanced/resource-limits "Resource Limits"
.Pp
.It Sy chains. Ns Ar chain Ns Sy .cacert
Certificate to verify the server when connecting to it.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry
Retry policy.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry.total
The maximum number of times to retry a request before giving up.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry.max_backoff_wait
The maximum time in seconds to wait between retries.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry.backoff_factor
The factor by which the wait time increases with each retry attempt.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry.respect_retry_after_header
Whether to respect the Retry-After header in HTTP responses when deciding how long to wait before retrying.
.Pp
.It Sy chains. Ns Ar chain Ns Sy .retry.backoff_jitter
The amount of jitter to add to the backoff time, between 0 and 1.
.Pp
.It Sy labels
List of labels for the API server.
.Pp
.It Sy director
Director configuration.
.Pp
.It Sy director.logs
Path to the logs directory created by Director.
.Pp
.It Sy appjail
AppJail configuration.
.Pp
.It Sy appjail.logs
Path to the logs directory created by AppJail.
.Pp
.It Sy appjail.images
Location of AppJail images.
.Pp
.It Sy appjail.jails
Location of jails.
.Pp
.It Sy components
Where to store components used in some operations such as creating virtual machines.
.Pp
.It Sy beanstalkd_addr
Beanstalkd address to connect to. Use the
.Sy unix:
prefix to connect to a UNIX socket. If the port is not specified,
.Sy 11300
will be used.
.Pp
.It Sy execution_time
Maximum time to execute a command or
.Sy null
to not set a timeout.
.Pp
.It Sy dataplaneapi
Data Plane API settings to configure HAProxy.
.Pp
.It Sy dataplaneapi.auth
Data Plane API authentication parameters.
.Pp
.It Sy dataplaneapi.auth.username
Data Plane API username.
.Pp
.It Sy dataplaneapi.auth.password
Data Plane API password.
.Pp
.It Sy dataplaneapi.entrypoint
.It Sy dataplaneapi.timeout
.It Sy dataplaneapi.read_timeout
.It Sy dataplaneapi.write_timeout
.It Sy dataplaneapi.connect_timeout
.It Sy dataplaneapi.pool_timeout
.It Sy dataplaneapi.max_keepalive_connections
.It Sy dataplaneapi.max_connections
.It Sy dataplaneapi.keepalive_expiry
.It Sy dataplaneapi.cacert
See
.Sy chains. Ns Ar chain Ns Sy .*
for details.
.Pp
.It Sy skydns
.No Configuration to manipulate the SkyDNS Ns / Ns Xr coredns-etcd 7 No plugin.
.Pp
.It Sy skydns.path
The path inside etcd.
.Pp
.It Sy skydns.zone
Authoritative zone.
.Pp
.It Sy etcd
Configuration to connect to etcd instances.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .port
Port to connect to the etcd instance.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .protocol
Protocol
.Po or scheme Pc Ns "."
.Pp
.It Sy etcd. Ns Ar host Ns Sy .ca_cert
Local cert to use as client side certificate.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .cert_key
Private key.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .timeout
Number of seconds to wait for the client to establish a connection to the etcd
instance and to wait for the server to send a response.
.Pp
.It Sy etcd. Ns Ar host Ns Sy .api_path
The part that specifies the API version of etcd. Do not specify any if you want
to leave the responsability of discovering the API version to the library.
.Pp
.It Sy max_watch_projects
Maximum number of jobs to wait in parallel to create or destroy projects, which
must be greater than or equal to 1. By default, the number of available CPUs is
used.
.Pp
.It Sy max_watch_vm
Like
.Sy max_watch_projects
but for virtual machines.
.Pp
.It Sy metadata
Metadata configuration parameters.
.Pp
.It Sy metadata.location
Path to a directory to store the metadata. If the specified directory doesn't exist,
it will be created when writing any metadata.
.Pp
.It Sy metadata.size
Size of each metadata. If a user tries to create a metadata with a size greater
than or equal to this parameter, an error occurs. By default this parameter is
set to 1 MiB.
.Pp
.It Sy autodisable
Smart Timeouts is an Overlord feature that disables a chain that fails until it
comes back online.
.Pp
Technically, this does not disable the chain, but the chain does not appear in
the API server's list of chains, so a client will only see
.Pq with a probability
chains that are known to work
.Po until they don't Pc Ns ,
ensuring more stability than showing the client an unnecessary failure
.Po and also reducing performance due to constant timeouts Pc Ns "."
.Pp
.It Sy autodisable.enabled
Enable or disable Smart Timeouts.
.Pp
.It Sy autodisable.failures
Maximum total number of failures to tolerate.
.Pp
If the maximum total number of failures is greater than this number, the interval
is checked.
.Pp
.It Sy autodisable.interval
The length of time a chain remains disabled.
.Pp
.It Sy autodisable.increase
This number affects the interval. When a comparison is made with the interval and
the last failure time, this number is added to the interval, thus increasing the
time a chain is disabled. The number adds to itself for each failure.
.Pp
.It Sy autodisable.max-increase
Maximum number for
.Sy autodisable.increase Ns "."
.Pp
.It Sy autodisable.strict
Avoid connecting to backlisted chains.
.Pp
.It Sy max_autoscale_logs
Maximum number of logs to be kept in memory.
.Pp
.It Sy autoscale_logs_expire_time
Keep the logs in memcached for the specified seconds.
.Pp
.El
.Sh DEPLOYMENT
.Ss GLOBAL
.Pp
.Bl -tag -compact -width xxx
.It Sy kind
What kind of deployment is this file.
.Pp
Valid choices are
.Sy directorProject Ns , Sy metadata No and Sy vmJail Ns "."
.Pp
.It Sy datacenters
Servers to perform HTTP requests.
.Pp
.It Sy datacenters. Ns Ar datacenter Ns Sy .entrypoint
.It Sy datacenters. Ns Ar datacenter Ns Sy .access_token
.It Sy datacenters. Ns Ar datacenter Ns Sy .timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .read_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .write_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .connect_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .pool_timeout
.It Sy datacenters. Ns Ar datacenter Ns Sy .max_keepalive_connections
.It Sy datacenters. Ns Ar datacenter Ns Sy .max_connections
.It Sy datacenters. Ns Ar datacenter Ns Sy .keepalive_expiry
See
.Sy chains. Ns Ar chain Ns Sy .*
in
.Sx CONFIGURATION
for details.
.Pp
.It Sy deployIn
Specify where to deploy.
.Pp
.It Sy deployIn.entrypoints
List of entry points to connect to that may have the chain with a syntax such as
.Sy  Ns Ar datacenter Ns Sy .{chainA}.{chainB}.
.Pp
By default, when no entry point is specified, data centers will be used as the
entry points.
.Pp
.It Sy deployIn.labels
Deploy to servers with these labels. When no labels are specified, the
.Sy all
label is used.
.Pp
.It Sy deployIn.exclude
Exclude servers matching the specified labels.
.Pp
.It Sy maximumDeployments
The maximum number of times to deploy a project.
.Pp
.El
.Ss metadata
Metadata allows simple text files to be created in the corresponding
.Sy Overlord
instances.
Metadata is integrated with other
.Sy Overlord
parameters or subsystems, so it can be reused for multiple things.
.Pp
.Bl -tag -compact -width xxx
.It Sy metadata
A dictionary specifiying the metadata to be stored.
.Pp
.El
.Ss directorProject
Director is used for the creation of a project, a simple text file in YAML format
that deploys one or more services
.Pq aka jails
on a single system.
.Pp
.Bl -tag -compact -width xxx
.It Sy projectName
Project name.
.Pp
.It Sy projectFile
Content of the project.
.Pp
.It Sy projectFromMetadata
Like
.Sy projectFile
but it obtains the content of the project from a metadata.
.Pp
.It Sy environment
A dictionary with each key-value environment. Both the key and the value must be a string.
.Pp
.It Sy environFromMetadata
Like
.Sy environment
but obtains a dictionary from a metadata in YAML format.
.Pp
.It Sy datacentersEnvironment
Each key must be a datacenter and its value a dictionary such as
.Sy environment
specifying the environment to use depending on the datacenter.
.Pp
This parameter overrides any other environment-like option.
.Pp
.It Sy chainsEnvironment
Each key must be a chain and its value a dictionary such as
.Sy environment
specifying the environment to use depending on the chain.
.Pp
This parameter overrides any other environment-like option except
.Sy datacentersEnvironment Ns "."
.Pp
A special key
.Sy <root>
can be used when a request is to be made to a datacenter but without specifiying a chain.
.Pp
.It Sy labelsEnvironment
Each key must be a label and its value a dictionary such as
.Sy environment
specifying the environment to use depending on whether the datacenter and its chain
have a label that matches a key.
.Pp
This parameter overrides any other environment-like option except
.Sy datacentersEnvironment
and
.Sy chainsEnvironment Ns "."
.Pp
.It Sy autoScale
When at least one option of this parameter is set, a metadata named
.Sy overlord.autoscale. Ns Ar project
is created instead of simply deploying the project to the matching nodes. It is
assumed that the remote Overlord instance will read the metadata to deploy and
autoscale the project depending on how many chains it has.
.Pp
The counterpart to destroying a project is to create another metadata named
.Sy overlord.autoscale-cleanup. Ns Ar project Ns "."
This is an indication to the Overlord instance not to deploy any more projects
and to destroy the ones that are currently deployed.
.Pp
If the
.Sy overlord.autoscale. Ns Ar project
metadata have at least one change, the project is redeployed to the nodes that
have the project.
.Pp
.It Sy autoScale.replicas
Configuration parameters used to replicate the project.
.Pp
.It Sy autoScale.replicas.min
The minimum number of replicas this project will have. It depends on the number
of matching and working chains.
.Pp
.It Sy autoScale.replicas.max
When scaling the project due to
.Xr rctl 8
rules, this limits the number of deployments. By default, the number of matched
and working chains calculated at runtime is used.
.Pp
.It Sy autoScale.type
When at least one
.Xr rctl 8
rule is specified to scale the project based on the jail metrics, this indicates
how the metric should be evaluated.
.Pp
.Bl -tag -width xxxxx
.It Sy any-jail
Fails if any of the jails have a metric greater than or equal to the specified
limit.
.It Sy any-project
Fails if the metric total for all jails in the same project is greater than or
equal to the specified limit.
.It Sy average
Calculates the average of the metric for all jails in the same project and fails
if it is greater than or equal to the specified limit.
.It Sy percent-jail
Calculates the percentage of the specified limit and fails if it is greater than or equal to the current metric. For example, if you define a rule as
.Dq vmemoryuse=512m
and a percentage of
.Sy 60 Ns ,
the value will be
.Sy 307
.Po rounded Pc Ns ,
so this test fails if the current metric is greater than or equal to
.Sy 307 Ns "."
.It Sy percent-project
Like
.Sy percent-jail Ns ,
but first get the metric total for all jails in the same project
.El
.Pp
.It Sy autoScale.value
If the type requires a value such as
.Sy percent-jail
or
.Sy percent-project Ns ,
this parameter must be used.
.Pp
.It Sy autoScale.rules
A dictionary specifying the
.Xr rctl 8
rules. Each key-value must specify the rule and the limit, and if that limit is
reached, more instances of the project will be created.
.Pp
.It Sy autoScale.labels
See
.Sy deployIn.labels
for details.
.Pp
.El
.Ss readOnly
This deployment is only useful for use with the
.Sy get-info
command and can't be used with
.Sy apply
or
.Sy destroy Ns "."
.Ss appConfig
Gets a Mako template from a metadata and substitutes variables, generating a new
deployment file that can only be a
.Sy directorProject
or
.Sy vmJail
deployment. The resulting deployment file is temporary and is created each time
the
.Sy appConfig
deployment is applied. Once the deployment file is created from the Mako template,
it is applied.
.Pp
Even if you have deployed the metadata in many chains, only the first match in an
.Sy appConfig
deployment is used.
.Pp
See also
.Lk https://docs.makotemplates.org/en/latest/syntax.html "Mako syntax"
.Pp
.Bl -tag -width xxxxx
.It Sy appName
Application name.
.Pp
The variable
.Sy ${appName}
is automatically set and must be used in the Mako template, however this is not
enforced in any way.
.Pp
.It Sy appFrom
Metadata to obtain the Mako template.
.Pp
In addition to the parameters required for the specified deployment type, you must
include at least the
.Sy kind
parameter.
.Sy datacenters Ns ,
.Sy deployIn
and
.Sy maximumDeployments
parameters are set by Overlord when processing the
.Sy appConfig
deployment.
.Pp
.It Sy appConfig
A dictionary where each key represents the variable to be substituted when processing
the Mako template.
.El
.Ss vmJail
Deploy a new project that will create a new jail to then create a virtual machine.
This kind of deployment integrates well with
.Sy Overlord
because the information it gets comes from the project and the jail.
.Pp
A virtual disk is created and partitioned. This deployment file specifies the
files to be installed on the root partition that must correspond to the FreeBSD
installation. Once this process is complete, a new virtual machine will be up
and running.
.Pp
.Bl -tag -width xxxxx
.It Sy vmName
The name of the project, the jail and the virtual machine.
.Pp
.It Sy makejail
The Makejail to create the environment. This Makejail must install at least
.Xr vm-bhyve 8
.Pq stable or devel
for this kind of deployment to work properly. Apart from installing
.Xr vm-bhyve 8
you must specify the network options of the jail, such as using Virtual Networks, configure the bridge, create the switch, and unhide the devices for
.Xr bhyve 4
to work correctly.
.Pp
.It Sy makejailFromMetadata
Like
.Sy makejail
but it obtains the content of the Makejail from a metadata.
.Pp
.It Sy template
A dictionary where each key-value will be written as a
.Xr vm-bhyve 8
template. The parameters
.Sy disk0_type Ns ,
.Sy disk0_name Ns ,
.Sy disk0_dev
and
.Sy disk0_size
will be written by
.Sy Overlord
when creating the template.
.Pp
.Sy disk0_type
is whatever is specified in
.Sy diskLayout.driver Ns ,
.Sy disk0_name
is
.Sy disk0.img Ns ,
.Sy disk0_dev
is
.Sy file
and
.Sy disk0_size
is whatever is specified in
.Sy diskLayout.size Ns "." 
.Pp
.It Sy diskLayout
Configuration parameters for the virtual disk.
.Pp
.It Sy diskLayout.driver
The emulation type for the virtual disk.
.Pp
Only
.Sy nvme
and
.Sy virtio-blk
are supported.
.Pp
.It Sy diskLayout.size
Size of the virtual disk.
.Pp
.It Sy diskLayout.from
Configuration parameters to determine how FreeBSD will be installed.
.Pp
.It Sy diskLayout.from.type
How to install FreeBSD. Depending on this parameter, some parameters
may or may not be valid.
.Pp
Only
.Sy appjailImage Ns ,
.Sy components
and
.Sy iso
are supported.
.Pp
.It Sy diskLayout.from.isoFile
The name of the ISO file containing the operating system to install. Due to the
nature of
.Sy Overlord Ns ,
which deploys jails and VMs not necessarily on your local machine, you must use
configure the VM template for use with VNC.
.Pp
See also
.Lk https://github.com/churchers/vm-bhyve/wiki/UEFI-Graphics-(VNC) "UEFI Graphics (VNC)"
.Pp
This parameter is only valid for the
.Sy iso
type.
.Pp
.It Sy diskLayout.from.installed
A boolean to indicate whether the VM can be enabled and started for persistent
use. Or in other words, after installing the operating system, you must modify
your deployment file and include this parameter set to
.Sy true Ns "."
.Pp
This parameter is only valid for the
.Sy iso
type.
.Pp
.It Sy diskLayout.from.components
A list of components to download and extract into the VM root partition.
.Pp
This parameter is only valid for the
.Sy components
type.
.Pp
.It Sy diskLayout.from.osVersion
FreeBSD version.
.Pp
This parameter is only valid for the
.Sy components
type.
.Pp
.It Sy diskLayout.from.osArch
FreeBSD architecture.
.Pp
This parameter is only valid for the
.Sy components
type.
.Pp
.It Sy diskLayout.from.downloadURL
URL of the web site where the components will be downloaded. The special strings
.Sy {ARCH}
and
.Sy {VERSION}
will be replaced by the values specified in the
.Sy osArch
and
.Sy osVersion
parameters.
.Pp
This parameter is only valid for the
.Sy components
type.
.Pp
.It Sy diskLayout.from.entrypoint
Where and how to obtain the
.Xr appjail-ajspec(5)
file to then obtain the image to be extracted to the VM root partition.
.Pp
This parameter is only valid for the
.Sy appjailImage
type.
.Pp
.It Sy diskLayout.from.imageName
Image name that does not necessarily correspond to the one specified in the
.Xr appjail-ajspec 5
file, although it is recommended to use the same value as the one specified in the
.Sy name
parameter of that file.
.Pp
This parameter is only valid for the
.Sy appjailImage
type.
.Pp
.It Sy diskLayout.from.imageArch
Obtain and use the image that matches this architecture.
.Pp
This parameter is only valid for the
.Sy appjailImage
type.
.Pp
.It Sy diskLayout.from.imageTag
Obtain and use the image that matches this tag.
.Pp
This parameter is only valid for the
.Sy appjailImage
type.
.Pp
.It Sy diskLayout.disk
Configuration parameters of virtual disk partitions, scheme and boot code.
.Pp
.It Sy diskLayout.disk.scheme
Specify the partitioning scheme to use.
.Pp
.It Sy diskLayout.disk.partitions
A list of dictionaries specifying the configuration parameters of the virtual
disk partition.
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .type
Create a partition of type
.Ar type Ns "."
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .alignment
If specified, then
.Sy Overlord
tries to align
.Ar start
offset and partition
.Ar size
to be multiple of
.Ar alignment
value.
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .start
The logical block address where the partition will begin.
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .size
Create a partition of size
.Ar size Ns "."
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .label
The label attached to the partition.  This option is only valid when used on
partitioning schemes that support partition labels.
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .format
Configuration parameters for formatting the root partition.
.Pp
If this parameter is set, the root partition is not only formatted, but also mounted
and FreeBSD files are installed on it. You can specify this parameter multiple times,
but only the first one will be mounted, although all partitions with this parameter
will be formatted.
.Pp
.It Sy diskLayout.disk.partitions. Ns Ar partition Ns Sy .format.flags
.Xr newfs 8
flags.
.Pp
.It Sy diskLayout.disk.bootcode
Embed bootstrap code into the partitioning scheme's metadata on the root partition
or write bootstrap code into a partition.
.Pp
.It Sy diskLayout.disk.bootcode.bootcode
Embed bootstrap code from the file bootcode into the partitioning scheme's metadata.
.Pp
.It Sy diskLayout.disk.bootcode.partcode
Write the bootstrap code from the file partcode into the root partition specified by
.Sy diskLayout.disk.bootcode.index Ns "."
.Pp
.It Sy diskLayout.disk.bootcode.index
Specify the target partition for
.Sy diskLayout.disk.bootcode.partcode Ns "."
.Pp
.It Sy diskLayout.fstab
Specifies the entries to create an
.Xr fstab 5
file on the root partition.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .device
Special device or remote file system to be mounted.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .mountpoint
Mount point for the file system.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .type
Type of file system.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .options
Mount options associated with the file system.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .dump
Used for these file systems by the
.Xr dump 8
command to determine which file systems need to be dumped.
.Pp
.It Sy diskLayout.fstab. Ns Ar entry Ns Sy .pass
Used by the
.Xr fsck 8
and
.Xr quotacheck 8
programs to determine the order in which file system and quota checks are done
at reboot time.
.Pp
.It Sy script
A
.Xr sh 1
script intended to further customize the virtual machine. The VM root partition
is mounted on
.Sy /mnt
but inside the jail, however, the script runs in the jail directory not
.Sy /mnt Ns "."
.Pp
.It Sy metadata
A list of metadata to be copied to the
.Sy /metadata
directory inside the jail. The metadata must be previously deployed or it is
simply ignored.
.Pp
.It Sy options
Array of dictionaries where each dictionary
.Pq key and value
represents the option used by
.Xr appjail-quick 1 Ns "."
.Pp
Keys are mandatory, but values are optional.
.Pp
.It Sy script-environment
Array of dictionaries where each dictionary
.Pq key and value
represents the environment used by the script.
.Pp
Environment variables are not loaded automatically, they must be loaded from the
.Pa /metadata/environment
file which is always created even if this parameter is not specified.
.Pp
.It Sy start-environment
Array of dictionaries where each dictionary
.Pq key and value
represents the environment used by the
.Sy start
stage.
.Pp
.It Sy start-arguments
Array of dictionaries where each dictionary
.Pq key and value
represents the arguments used by the
.Sy start
stage.
.Pp
.It Sy build-environment
Array of dictionaries where each dictionary
.Pq key and value
represents the environment used by the
.Sy build
stage.
.Pp
.It Sy build-arguments
Array of dictionaries where each dictionary
.Pq key and value
represents the arguments used by the
.Sy build
stage.
.Pp
.El
.Sh SEE ALSO
.Xr overlord 1
.Sh AUTHORS
.An Jesús Daniel Colmenares Oviedo Aq Mt DtxdF@disroot.org
